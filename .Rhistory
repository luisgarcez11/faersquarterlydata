{
if ("nda_num" %in% names(.)) {
.$nda_num <- as.double(.$nda_num)
.
} else {
.
}
} %>%
{
if ("dose_amt" %in% names(.)) {
.$dose_amt <- as.double(.$dose_amt)
.
} else {
.
}
} %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.)))
drug_info <- bind_rows(drug_info, read_file  %>%
{
if (primary_suspect) {
filter(., role_cod == "PS")
} else {
.
}
} %>%
{
if (!is.null(drug_pattern)) {
filter(., stringr::str_detect(string = drugname, pattern = drug_pattern))
} else {
.
}
})
}
if (stringr::str_detect(ascii_drug_file, "indi|INDI")) {
read_file <- data.table::fread(ascii_drug_file, sep = "$", quote = "", fill = FALSE) %>%
mutate_at(c("primaryid", "caseid"), ~as.integer(.)) %>%
filter(!caseid %in% duplicated_caseids) %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.)))
indi_info <- bind_rows(indi_info, read_file  %>%
{
if (!is.null(drug_indication_pattern)) {
filter(., stringr::str_detect(string = indi_pt, pattern = drug_indication_pattern))
} else {
.
}
})
}
}
#set final structure for drug_indi_info
if (!is.null(drug_indication_pattern) & !is.null(drug_pattern)) {
drug_indi_info <- drug_info %>%
inner_join(indi_info %>% group_by(primaryid, caseid, indi_drug_seq) %>%
summarise(indi_pt = paste(sort(unique(indi_pt)), collapse = "/"), .groups = "keep") %>%
ungroup(), by = c("primaryid", "caseid", "drug_seq" = "indi_drug_seq"))
}
if (!is.null(drug_indication_pattern) & is.null(drug_pattern)) {
if (primary_suspect == TRUE) {
drug_indi_info <- drug_info %>%
inner_join(indi_info %>% group_by(primaryid, caseid, indi_drug_seq) %>%
summarise(indi_pt = paste(sort(unique(indi_pt)), collapse = "/"), .groups = "keep") %>%
ungroup(), by = c("primaryid", "caseid", "drug_seq" = "indi_drug_seq"))
} else {
drug_indi_info <- indi_info
}
}
if (is.null(drug_indication_pattern) & !is.null(drug_pattern)) {
drug_indi_info <- drug_info %>%
filter(!caseid %in% duplicated_caseids)
}
if (is.null(drug_indication_pattern) & is.null(drug_pattern)) {
drug_indi_info <- drug_info %>%
full_join(indi_info %>% group_by(primaryid, caseid, indi_drug_seq) %>%
summarise(indi_pt = paste(sort(unique(indi_pt)), collapse = "/"), .groups = "keep") %>%
ungroup(), by = c("primaryid", "caseid", "drug_seq" = "indi_drug_seq"))
}
#filter drug_info & indi_info
drug_info <- drug_info %>% filter(primaryid %in% drug_indi_info$primaryid) %>%
mutate_at("drugname", ~stringr::str_replace_all(., pattern = "AND", replacement = "\\\\")) %>%
mutate_at("drugname", ~stringr::str_squish(.))
indi_info <- indi_info %>% filter(primaryid %in% drug_indi_info$primaryid)
# cache objects to be filled
cache <- list()
cache_files <- c()
# files to be filled
demo_info <- tibble::tibble()
outc_info <- tibble::tibble()
reac_info <- tibble::tibble()
rpsr_info <- tibble::tibble()
ther_info <- tibble::tibble()
for (ascii_file in ascii_files) {
message(paste("binding", ascii_file, which(ascii_file == ascii_files), "out of", length(ascii_files)))
if (stringr::str_detect(ascii_file, "demo|DEMO")) {
demo_info <- demo_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
{
if ("nda_num" %in% names(.)) {
.$nda_num <- as.integer(.$nda_num)
.
} else {
.
}
} %>%
mutate_at(c("age", "wt"), ~ as.integer(.)) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "outc|OUTC")) {
outc_info <- outc_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE) %>%
filter(!caseid %in% duplicated_caseids) %>%
{
if ("outc_cod" %in% names(.)) {
dplyr::rename(., "outc_code" = "outc_cod")
} else {
.
}
} %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "reac|REAC")) {
reac_info <- reac_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE) %>%
filter(!caseid %in% duplicated_caseids) %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "rpsr|RPSR")) {
rpsr_info <- rpsr_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "ther|THER")) {
ther_info <- ther_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
{
if ("dur" %in% names(.)) {
.$dur <- as.double(.$dur)
.
} else {
.
}
} %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (!is.null(cache_path)) {
message(paste("saving", ascii_file, "into cache:", cache_path))
cache_files <- c(cache_files, ascii_file)
ascii_list <- list(
demographics = demo_info,
drug = drug_info,
indication = indi_info,
outcome = outc_info,
reaction = reac_info,
report_source = rpsr_info,
therapy = ther_info
)
cache$files <- cache_files
save(cache, file = cache_path)
}
}
report_source
rpsr_info
ascii_file
ascii_file
ascii_files
ascii_file = "resources/test_zip_ex_dir/ASCII/RPSR22Q4.txt"
stringr::str_detect(ascii_file, "rpsr|RPSR")
data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)
a <- data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)
str(a$primaryid)
devtools::load_all("C:/Users/luis.ferreira/Desktop/faersquarterlydata")
faers_ascii_data <- retrieve_faersascii(ascii_dir = "resources/test_zip_ex_dir/ASCII",
duplicates_dir = "resources/deleted/")
faers_ascii_data
caseid <- role_cod <- drugname <- indi_pt <- primaryid <- indi_drug_seq <-
ichicsr <- . <- NULL
if (!dir.exists(ascii_dir)) {
stop("directory does not exist")
}
ascii_files <- list.files(ascii_dir, full.names = TRUE, pattern = ".txt")
ascii_drug_files <- ascii_files[which(stringr::str_detect(ascii_files, pattern = "drug|DRUG|indi|INDI"))]
ascii_files
ascii_drug_files
library(faersquarterlydata)
library(faersquarterlydata)
load("C:/Users/luis.ferreira/Desktop/faersquarterlydata_als/results/als_faers_data_unified.rda")
load("C:/Users/luis.ferreira/Desktop/faersquarterlydata_als/results/als_faers_data.rda")
als_faers_data$outcome
als_faers_data$demographics
als_faers_data$demographics$primaryid %>% is.integer()
als_faers_data$demographics$primaryid %>% is.integer()
als_faers_data$demographics$primaryid %>% as.integer()
als_faers_data$demographics$primaryid %>% as.character()
als_faers_data$demographics$primaryid %>% as.numeric()
als_faers_data$demographics$primaryid %>% as.numeric()[1]
als_faers_data$demographics$primaryid %>% as.numeric() %>% pull(1)
als_faers_data$demographics$primaryid[1] %>% as.numeric()
als_faers_data$demographics$primaryid[1] %>% as.integer()
library(faersquarterlydata)
library(faersquarterlydata)
load("C:/Users/luis.ferreira/Desktop/faersquarterlydata/data/als_faers_data.rda")
als_faers_data
ascii_dir
ascii_dir = "/Users/luis.ferreira/Desktop/faersquarterlydata_als/data-raw/faers_data_unzipped2/"
ascii_dir
ascii_dir = "/Users/luis.ferreira/Desktop/faersquarterlydata_als/data-raw/faers_data_unzipped2/ascii/"
#setting global vars
caseid <- role_cod <- drugname <- indi_pt <- primaryid <- indi_drug_seq <-
ichicsr <- . <- NULL
if (!dir.exists(ascii_dir)) {
stop("directory does not exist")
}
drug_indication_pattern
drug_indication_pattern = "amyotrophic lateral sclerosis"
drug_indication_pattern = "Amyotrophic lateral sclerosis"
library(tidylog)
drug_pattern = NULL
primary_suspect = TRUE
#setting global vars
caseid <- role_cod <- drugname <- indi_pt <- primaryid <- indi_drug_seq <-
ichicsr <- . <- NULL
if (!dir.exists(ascii_dir)) {
stop("directory does not exist")
}
ascii_files <- list.files(ascii_dir, full.names = TRUE, pattern = ".txt")
ascii_drug_files <- ascii_files[which(stringr::str_detect(ascii_files, pattern = "drug|DRUG|indi|INDI"))]
ascii_files
ascii_files
ascii_dir
ascii_files <- list.files(ascii_dir, full.names = TRUE, pattern = ".txt")
ascii_files
ascii_dir
ascii_dir =  "/Users/luis.ferreira/Desktop/faersquarterlydata_als/data-raw/faers_data_unzipped/ascii/"
ascii_files <- list.files(ascii_dir, full.names = TRUE, pattern = ".txt")
ascii_files
ascii_files <- list.files(ascii_dir, full.names = TRUE, pattern = ".txt")
ascii_drug_files <- ascii_files[which(stringr::str_detect(ascii_files, pattern = "drug|DRUG|indi|INDI"))]
#getduplicated caseIDs
duplicated_caseids <- get_duplicate_caseids(...)
duplicated_caseids
duplicates_dir = "/Users/luis.ferreira/Desktop/faersquarterlydata_als/data-raw/faers_data_unzipped/deleted/"
duplicated_caseids <- get_duplicate_caseids(duplicates_dir = "/Users/luis.ferreira/Desktop/faersquarterlydata_als/data-raw/faers_data_unzipped/deleted/")
duplicated_caseids
# gather drug files
drug_info <- tibble::tibble()
indi_info <- tibble::tibble()
drug_indi_info <- tibble::tibble()
ascii_drug_files
# iterating over drug and indication files to filter the chosen ADRs
for (ascii_drug_file in ascii_drug_files) {
message(paste(
"Retrieving drug/indication information: binding", ascii_drug_file,
which(ascii_drug_file == ascii_drug_files), "out of", length(ascii_drug_files)
))
if (stringr::str_detect(ascii_drug_file, "drug|DRUG")) {
read_file <- data.table::fread(ascii_drug_file, sep = "$", quote = "", fill = FALSE) %>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids) %>%
{
if ("nda_num" %in% names(.)) {
.$nda_num <- as.character(.$nda_num)
.
} else {
.
}
} %>%
{
if ("dose_amt" %in% names(.)) {
.$dose_amt <- as.character(.$dose_amt)
.
} else {
.
}
} %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.)))
drug_info <- bind_rows(drug_info, read_file  %>%
{
if (primary_suspect) {
filter(., role_cod == "PS")
} else {
.
}
} %>%
{
if (!is.null(drug_pattern)) {
filter(., stringr::str_detect(string = drugname, pattern = drug_pattern))
} else {
.
}
})
}
if (stringr::str_detect(ascii_drug_file, "indi|INDI")) {
read_file <- data.table::fread(ascii_drug_file, sep = "$", quote = "", fill = FALSE) %>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids) %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.)))
indi_info <- bind_rows(indi_info, read_file  %>%
{
if (!is.null(drug_indication_pattern)) {
filter(., stringr::str_detect(string = indi_pt, pattern = drug_indication_pattern))
} else {
.
}
})
}
}
drug_info %>%
inner_join(indi_info %>% group_by(primaryid, caseid, indi_drug_seq) %>%
summarise(indi_pt = paste(sort(unique(indi_pt)), collapse = "/"), .groups = "keep") %>%
ungroup(), by = c("primaryid", "caseid", "drug_seq" = "indi_drug_seq"))
drug_indi_info <- drug_info %>%
inner_join(indi_info %>% group_by(primaryid, caseid, indi_drug_seq) %>%
summarise(indi_pt = paste(sort(unique(indi_pt)), collapse = "/"), .groups = "keep") %>%
ungroup(), by = c("primaryid", "caseid", "drug_seq" = "indi_drug_seq"))
drug_indi_info
#filter drug_info & indi_info
drug_info <- drug_info %>% filter(primaryid %in% drug_indi_info$primaryid) %>%
mutate_at("drugname", ~stringr::str_replace_all(., pattern = "AND", replacement = "\\\\")) %>%
mutate_at("drugname", ~stringr::str_squish(.))
indi_info <- indi_info %>% filter(primaryid %in% drug_indi_info$primaryid)
drug_indi_info$primaryid
# cache objects to be filled
cache <- list()
cache_files <- c()
# files to be filled
demo_info <- tibble::tibble()
outc_info <- tibble::tibble()
reac_info <- tibble::tibble()
rpsr_info <- tibble::tibble()
ther_info <- tibble::tibble()
ascii_files
ascii_file
library(faersquarterlydata)
#read the files and remove the duplicated cases, impute date, and filter by caseIDs with specified drug and drug indication patterns
for (ascii_file in ascii_files) {
message(paste("binding", ascii_file, which(ascii_file == ascii_files), "out of", length(ascii_files)))
if (stringr::str_detect(ascii_file, "demo|DEMO")) {
demo_info <- demo_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
{
if ("nda_num" %in% names(.)) {
.$nda_num <- as.character(.$nda_num)
.
} else {
.
}
} %>%
mutate_at(c("age", "wt"), ~ suppressWarnings(as.numeric(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "outc|OUTC")) {
outc_info <- outc_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE) %>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids) %>%
{
if ("outc_cod" %in% names(.)) {
dplyr::rename(., "outc_code" = "outc_cod")
} else {
.
}
} %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "reac|REAC")) {
reac_info <- reac_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE) %>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids) %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "rpsr|RPSR")) {
rpsr_info <- rpsr_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "ther|THER")) {
ther_info <- ther_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
{
if ("dur" %in% names(.)) {
.$dur <- as.character(.$dur)
.
} else {
.
}
} %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (!is.null(cache_path)) {
message(paste("saving", ascii_file, "into cache:", cache_path))
cache_files <- c(cache_files, ascii_file)
ascii_list <- list(
demographics = demo_info,
drug = drug_info,
indication = indi_info,
outcome = outc_info,
reaction = reac_info,
report_source = rpsr_info,
therapy = ther_info
)
cache$files <- cache_files
save(cache, file = cache_path)
}
}
cache_path = NULL
# files to be filled
demo_info <- tibble::tibble()
outc_info <- tibble::tibble()
reac_info <- tibble::tibble()
rpsr_info <- tibble::tibble()
ther_info <- tibble::tibble()
#read the files and remove the duplicated cases, impute date, and filter by caseIDs with specified drug and drug indication patterns
for (ascii_file in ascii_files) {
message(paste("binding", ascii_file, which(ascii_file == ascii_files), "out of", length(ascii_files)))
if (stringr::str_detect(ascii_file, "demo|DEMO")) {
demo_info <- demo_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
{
if ("nda_num" %in% names(.)) {
.$nda_num <- as.character(.$nda_num)
.
} else {
.
}
} %>%
mutate_at(c("age", "wt"), ~ suppressWarnings(as.numeric(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "outc|OUTC")) {
outc_info <- outc_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE) %>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids) %>%
{
if ("outc_cod" %in% names(.)) {
dplyr::rename(., "outc_code" = "outc_cod")
} else {
.
}
} %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "reac|REAC")) {
reac_info <- reac_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE) %>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids) %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "rpsr|RPSR")) {
rpsr_info <- rpsr_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (stringr::str_detect(ascii_file, "ther|THER")) {
ther_info <- ther_info %>% bind_rows(data.table::fread(ascii_file, sep = "$", quote = "", fill = FALSE)%>%
mutate_at(c("primaryid", "caseid"), ~as.numeric(.)) %>%
filter(!caseid %in% duplicated_caseids)  %>%
mutate_at(vars(ends_with("_dt")), list(~ arrange_date(.))) %>%
{
if ("dur" %in% names(.)) {
.$dur <- as.character(.$dur)
.
} else {
.
}
} %>%
filter(primaryid %in% drug_indi_info$primaryid))
}
if (!is.null(cache_path)) {
message(paste("saving", ascii_file, "into cache:", cache_path))
cache_files <- c(cache_files, ascii_file)
ascii_list <- list(
demographics = demo_info,
drug = drug_info,
indication = indi_info,
outcome = outc_info,
reaction = reac_info,
report_source = rpsr_info,
therapy = ther_info
)
cache$files <- cache_files
save(cache, file = cache_path)
}
}
library(faersquarterlydata)
as.numeric(54)/365*7
as.numeric(24*54)/(365*24)
as.numeric(24*54)/(365)
as.numeric(24*54)
as.numeric(24*54)/(365*3)
as.numeric(24*54)/(365*2)
as.numeric(24*54)/(365*4)
as.numeric(24*54)/(365*3)
as.numeric(24*54)/(365*3.5)
as.numeric(24*365)/(365*24)
as.numeric(54)/(365/7)
library(faersquarterlydata)
library(faersquarterlydata)
library(faersquarterlydata)
